{"id":"47f15f18-285b-463b-8968-3abf49fd7541","zed":"context","version":"0.4.0","text":"\n\n\n\n```go picow-led/services/devices.go\npackage services\n\nimport (\n\t\"log/slog\"\n\n\t\"github.com/knackwurstking/picow-led/models\"\n)\n\ntype Devices struct {\n\tregistry *Registry\n}\n\nfunc NewDevices(r *Registry) *Devices {\n\treturn &Devices{\n\t\tregistry: r,\n\t}\n}\n\nfunc (d *Devices) CreateTable() error {\n\tquery := `CREATE TABLE IF NOT EXISTS devices (\n\t\tid INTEGER PRIMARY KEY NOT NULL,\n\t\taddr TEXT UNIQUE NOT NULL,\n\t\tname TEXT NOT NULL,\n\t\tcreated_at DATETIME DEFAULT CURRENT_TIMESTAMP\n\t\tFOREIGN KEY (id) REFERENCES pins(device_id) ON DELETE CASCADE,\n\t);`\n\n\t_, err := d.registry.db.Exec(query)\n\treturn err\n}\n\nfunc (d *Devices) Get(id models.DeviceID) (*models.Device, error) {\n\tslog.Debug(\"Get device from database\", \"table\", \"devices\", \"id\", id)\n\n\tquery := `SELECT * FROM devices WHERE id = ?`\n\tdevice, err := ScanDevice(d.registry.db.QueryRow(query, id))\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\treturn device, nil\n}\n\nfunc (d *Devices) GetByAddr(addr models.Addr) (*models.Device, error) {\n\tslog.Debug(\"Get device from database\", \"table\", \"devices\", \"addr\", addr)\n\n\tquery := `SELECT * FROM devices WHERE addr = ?`\n\tdevice, err := ScanDevice(d.registry.db.QueryRow(query, addr))\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\treturn device, nil\n}\n\nfunc (d *Devices) List() ([]*models.Device, error) {\n\trows, err := d.registry.db.Query(`SELECT * FROM devices`)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tdefer rows.Close()\n\n\tvar devices []*models.Device\n\tfor rows.Next() {\n\t\tdevice, err := ScanDevice(rows)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t\tdevices = append(devices, device)\n\t}\n\n\treturn devices, nil\n}\n\nfunc (d *Devices) Add(device *models.Device) (models.DeviceID, error) {\n\tquery := `INSERT INTO devices (addr, name) VALUES (?, ?)`\n\tresult, err := d.registry.db.Exec(query, device.Addr, device.Name)\n\tif err != nil {\n\t\treturn 0, err\n\t}\n\n\tid, err := result.LastInsertId()\n\tif err != nil {\n\t\treturn 0, err\n\t}\n\n\treturn models.DeviceID(id), nil\n}\n\nfunc (d *Devices) Update(device *models.Device) error {\n\tquery := `UPDATE devices SET addr = ?, name = ? WHERE id = ?`\n\t_, err := d.registry.db.Exec(query, device.Addr, device.Name, device.ID)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}\n\nfunc (d *Devices) Delete(id models.DeviceID) error {\n\tquery := `DELETE FROM devices WHERE id = ?`\n\t_, err := d.registry.db.Exec(query, id)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}\n\nfunc ScanDevice(r Scannable) (*models.Device, error) {\n\tvar device models.Device\n\terr := r.Scan(&device.ID, &device.Addr, &device.Name, &device.CreatedAt)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\treturn &device, nil\n}\n```\n\nwhat does the \"FOREIGN KEY...\" line do\n\nThe `FOREIGN KEY` line in your SQL schema definition is used to establish a link between two tables. It ensures that all references in the referencing table (in this case, the `pins` table) to a column in the referenced table (`devices.id`) are valid.\n\nHere's what it does:\n\n1. **Foreign Key Definition**: The line defines a foreign key constraint on the `device_id` column of the `pins` table.\n   ```go\n   FOREIGN KEY (id) REFERENCES pins(device_id) ON DELETE CASCADE,\n   ```\n\n2. **Referenced Table and Column**: It references the `devices` table and specifically points to the `id` column within that table.\n\n3. **Cascade On Delete**: The `ON DELETE CASCADE` clause specifies what should happen when a row in the referenced table (`devices`) is deleted:\n   - If a row in the `devices` table is deleted, all rows in the `pins` table where the `device_id` matches will also be automatically deleted.\n   - This ensures referential integrity, preventing orphaned records in the `pins` table.\n\nIn summary, this line establishes a relationship between the `pins` and `devices` tables, ensuring that:\n- Each `device_id` in the `pins` table corresponds to an existing `id` in the `devices` table.\n- When a device is deleted from the `devices` table, all related entries in the `pins` table are automatically removed, maintaining a clean and consistent database.\n","messages":[{"id":{"replica_id":0,"value":0},"start":0,"metadata":{"role":"user","status":"Done","timestamp":{"replica_id":0,"value":48}}},{"id":{"replica_id":0,"value":42},"start":2624,"metadata":{"role":"assistant","status":"Done","timestamp":{"replica_id":0,"value":49}}},{"id":{"replica_id":0,"value":43},"start":3980,"metadata":{"role":"user","status":"Done","timestamp":{"replica_id":0,"value":50}}}],"summary":"FOREIGN KEY Constraint Explained","slash_command_output_sections":[{"range":{"start":0,"end":1},"icon":"Library","label":"Default","metadata":null},{"range":{"start":4,"end":2583},"icon":"File","label":"picow-led/services/devices.go","metadata":{"path":"picow-led/services/devices.go"}}],"thought_process_output_sections":[]}